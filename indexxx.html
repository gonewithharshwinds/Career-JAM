<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerJAM by MehtaVerse</title>
    
    <!-- 1. Removed Font Awesome -->
    
    <!-- 2. Added Google Fonts for Theme & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400..900&family=Fira+Code:wght@400;500&family=Manrope:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- The new Material Symbols (Variable) import -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>

    <!-- 3. Integrate Theme directly into Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': 'var(--background)',
                        'foreground': 'var(--foreground)',
                        'card': 'var(--card)',
                        'card-foreground': 'var(--card-foreground)',
                        'popover': 'var(--popover)',
                        'popover-foreground': 'var(--popover-foreground)',
                        'primary': 'var(--primary)',
                        'primary-foreground': 'var(--primary-foreground)',
                        'secondary': 'var(--secondary)',
                        'secondary-foreground': 'var(--secondary-foreground)',
                        'muted': 'var(--muted)',
                        'muted-foreground': 'var(--muted-foreground)',
                        'accent': 'var(--accent)',
                        'accent-foreground': 'var(--accent-foreground)',
                        'destructive': 'var(--destructive)',
                        'destructive-foreground': 'var(--destructive-foreground)',
                        'border': 'var(--border)',
                        'input': 'var(--input)',
                        'ring': 'var(--ring)',
                    },
                    fontFamily: {
                        sans: ['var(--font-sans)', 'sans-serif'],
                        serif: ['var(--font-serif)', 'serif'],
                        mono: ['var(--font-mono)', 'monospace'],
                    },
                    borderRadius: {
                        'lg': 'var(--radius)',
                        'md': 'calc(var(--radius) - 2px)',
                        'sm': 'calc(var(--radius) - 4px)',
                    },
                    boxShadow: {
                        'sm': 'var(--shadow-sm)',
                        'md': 'var(--shadow-md)',
                        'lg': 'var(--shadow-lg)',
                        'xl': 'var(--shadow-xl)',
                        '2xl': 'var(--shadow-2xl)',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* --- Added Theme Variables --- */
        :root {
            --background: #fdf8f5;
            --foreground: #663b49;
            --card: #ffffff;
            --card-foreground: #663b49;
            --popover: #ffffff;
            --popover-foreground: #663b49;
            --primary: #8a4933;
            --primary-foreground: #ffffff;
            --secondary: #dba08b;
            --secondary-foreground: #663b49;
            --muted: #f5ebe6;
            --muted-foreground: #b45f46;
            --accent: #c77961;
            --accent-foreground: #ffffff;
            --destructive: #ff4b4b;
            --destructive-foreground: #ffffff;
            --border: #e0d4cd;
            --input: #f5ebe6;
            --ring: #b45f46;
            --radius: 0.5rem;
            --font-sans: "Manrope", sans-serif;
            --font-serif: "Playfair Display", serif;
            --font-mono: "Fira Code", monospace;
            --shadow-sm: 0 0.25rem 0.5rem 0 hsl(340.4651 26.7081% 31.5686% / 0.10), 0 1px 2px -1px hsl(340.4651 26.7081% 31.5686% / 0.10);
            --shadow-md: 0 0.25rem 0.5rem 0 hsl(340.4651 26.7081% 31.5686% / 0.10), 0 2px 4px -1px hsl(340.4651 26.7081% 31.5686% / 0.10);
            --shadow-lg: 0 0.25rem 0.5rem 0 hsl(340.4651 26.7081% 31.5686% / 0.10), 0 4px 6px -1px hsl(340.4651 26.7081% 31.5686% / 0.10);
            --shadow-xl: 0 0.25rem 0.5rem 0 hsl(340.4651 26.7081% 31.5686% / 0.10), 0 8px 10px -1px hsl(340.4651 26.7081% 31.5686% / 0.10);
            --shadow-2xl: 0 0.25rem 0.5rem 0 hsl(340.4651 26.7081% 31.5686% / 0.25);
        }

        .dark {
            --background: #2e1c24;
            --foreground: #dba08b;
            --card: #3a242c;
            --card-foreground: #dba08b;
            --popover: #3a242c;
            --popover-foreground: #dba08b;
            --primary: #b45f46;
            --primary-foreground: #ffffff;
            --secondary: #663b49;
            --secondary-foreground: #dba08b;
            --muted: #452e36;
            --muted-foreground: #c77961;
            --accent: #8a4933;
            --accent-foreground: #ffffff;
            --destructive: #ff6b6b;
            --destructive-foreground: #ffffff;
            --border: #663b49;
            --input: #2e1c24;
            --ring: #c77961;
            --radius: 0.5rem;
            --font-sans: "Manrope", sans-serif;
            --font-serif: "Playfair Display", serif;
            --font-mono: "Fira Code", monospace;
            --shadow-sm: 0 0.25rem 0.5rem 0 hsl(0 0% 0% / 0.30), 0 1px 2px -1px hsl(0 0% 0% / 0.30);
            --shadow-md: 0 0.25rem 0.5rem 0 hsl(0 0% 0% / 0.30), 0 2px 4px -1px hsl(0 0% 0% / 0.30);
            --shadow-lg: 0 0.25rem 0.5rem 0 hsl(0 0% 0% / 0.30), 0 4px 6px -1px hsl(0 0% 0% / 0.30);
            --shadow-xl: 0 0.25rem 0.5rem 0 hsl(0 0% 0% / 0.30), 0 8px 10px -1px hsl(0 0% 0% / 0.30);
            --shadow-2xl: 0 0.25rem 0.5rem 0 hsl(0 0% 0% / 0.75);
        }
        /* --- End Theme Variables --- */

        /* 4. Base styles for Material Symbols */
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 20;
            vertical-align: bottom; /* Aligns icons with text */
        }

        body {
            font-family: var(--font-sans);
        }

        /* Custom scrollbar updated with theme colors */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--background); }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .modal { display: none; transition: opacity 0.3s ease; }
        .modal.flex { display: flex; }
        .modal-content { transition: transform 0.3s ease; }
        
        /* Updated custom classes with theme colors */
        .nav-link.active {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }
        .nav-link:not(.active):hover {
            background-color: var(--muted);
        }

        .status-tab.active {
            border-color: var(--primary);
            color: var(--primary);
        }
        .job-row:hover { background-color: var(--muted); }
        .job-row td[data-field="details"] { cursor: pointer; }
        td[data-field="notes"] {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        td[data-field="notes"]:hover {
            background-color: var(--muted);
        }
        
        .editable-select {
            background-color: var(--input);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: var(--radius);
            padding: 4px 8px;
            width: 100%;
        }
        
        .analyze-match-btn:disabled, #generate-ai-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Added spin animation for loading icon */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }

        /* Styles for new Kanban View */
        .view-toggle.active {
            background-color: var(--card);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        .kanban-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Fix for Prose colors */
        .prose {
            color: var(--card-foreground);
        }
        .prose strong {
            color: var(--foreground);
        }
        .prose a {
            color: var(--primary);
        }
        .prose code {
            color: var(--accent);
        }
        .prose ul > li::before {
            background-color: var(--muted-foreground);
        }
        
        /* Styles for column visibility toggle */
        .column-toggle-popover {
            display: none;
            position: absolute;
            z-index: 50;
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem;
        }
        .column-toggle-popover.show {
            display: block;
        }
        .column-toggle-popover label {
            display: block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            cursor: pointer;
        }
        .column-toggle-popover label:hover {
            background-color: var(--muted);
        }
        /* NEW: Styles for draggable column items */
        .column-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            cursor: grab;
            user-select: none;
        }
        .column-item:hover {
            background-color: var(--muted);
        }
        .column-item.dragging {
            opacity: 0.5;
            background-color: var(--secondary);
        }
        .column-item .drag-handle {
            cursor: grab;
            margin-right: 0.5rem;
            color: var(--muted-foreground);
        }
        .column-item .col-priority {
            margin-right: 0.5rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
            width: 1rem;
        }
        .column-item label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .column-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }


        /* Styles for pagination */
        .pagination-controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0 0.5rem;
        }
        .pagination-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--card);
            padding: 0.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .pagination-btn {
            background-color: var(--background);
            border: 1px solid var(--border);
            color: var(--foreground);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pagination-btn:hover {
            background-color: var(--muted);
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Styles for company grid */
        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .company-card {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }
        .company-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* NEW: Styles for Related Job Card */
        .related-job-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }
        .related-job-card {
            background-color: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
        }
        .related-job-card h4 {
            font-weight: 600;
            cursor: pointer;
        }
        .related-job-card h4:hover {
            color: var(--primary);
        }
        .related-job-card p {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            color: var(--muted-foreground);
            margin-top: 0.5rem;
        }


    </style>
</head>
<body class="bg-background text-foreground font-sans antialiased">
    <div id="app-container" class="flex flex-col h-screen">

        <!-- Header: Refactored with Tailwind theme classes and new icons -->
        <header class="bg-card shadow-md">
            <nav class="container mx-auto px-4 sm:px-6 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-2xl text-primary mr-2">smart_toy</span>
                        <!-- UPDATED: Title -->
                        <h1 class="text-xl font-bold">CareerJAM <span class="text-base font-normal italic opacity-80">by MehtaVerse</span></h1>
                    </div>
                    <!-- Add mobile menu button here if needed -->
                </div>
                <div class="flex items-center space-x-1 sm:space-x-2 mt-2 sm:mt-0 flex-wrap justify-center">
                    <button data-view="jobs-view" class="nav-link flex-col sm:flex-row flex items-center justify-center space-x-0 sm:space-x-1 px-3 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-card focus:ring-ring active">
                        <span class="material-symbols-outlined text-base">work</span>
                        <span>Jobs</span>
                    </button>
                    <button data-view="profiles-view" class="nav-link flex-col sm:flex-row flex items-center justify-center space-x-0 sm:space-x-1 px-3 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-card focus:ring-ring">
                        <span class="material-symbols-outlined text-base">badge</span>
                        <span>Profiles</span>
                    </button>
                    <button data-view="companies-view" class="nav-link flex-col sm:flex-row flex items-center justify-center space-x-0 sm:space-x-1 px-3 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-card focus:ring-ring">
                        <span class="material-symbols-outlined text-base">apartment</span>
                        <span>Companies</span>
                    </button>
                    <button data-view="people-view" class="nav-link flex-col sm:flex-row flex items-center justify-center space-x-0 sm:space-x-1 px-3 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-card focus:ring-ring">
                        <span class="material-symbols-outlined text-base">group</span>
                        <span>People</span>
                    </button>
                    <button data-view="logs-view" class="nav-link flex-col sm:flex-row flex items-center justify-center space-x-0 sm:space-x-1 px-3 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-card focus:ring-ring">
                        <span class="material-symbols-outlined text-base">history</span>
                        <span>Logs</span>
                    </button>
                    <button data-view="settings-view" class="nav-link px-3 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-card focus:ring-ring">
                        <span class="material-symbols-outlined">settings</span>
                    </button>
                </div>
            </nav>
        </header>

        <!-- Main Content: ADDED pb-8 for persistent footer -->
        <main class="flex-grow p-4 overflow-auto pb-8">
            <!-- Jobs View -->
            <div id="jobs-view" class="view-content">
                <!-- Jobs List View -->
                <div id="jobs-list-container">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <!-- Status Tabs (Hidden in Kanban) -->
                            <div id="status-tabs" class="flex space-x-2 border-b border-border overflow-x-auto">
                                <!-- Status tabs will be injected here -->
                            </div>
                            <!-- Sort (Hidden in Kanban) -->
                            <div id="sort-controls" class="pl-0 sm:pl-4 flex items-center gap-4">
                                <select id="sort-jobs-select" class="editable-select text-sm">
                                    <option value="created_at DESC">Sort by: Date (Newest)</option>
                                    <option value="salary DESC">Sort by: Salary (High)</option>
                                    <option value="match_percentage DESC">Sort by: Match % (High)</option>
                                    <option value="title ASC">Sort by: Position (A-Z)</option>
                                    <option value="company_name ASC">Sort by: Company (A-Z)</option>
                                </select>
                                <!-- NEW: Column Visibility Toggle -->
                                <div class="relative">
                                    <button id="manage-columns-btn" class="view-toggle p-2 rounded-md leading-none bg-muted flex items-center gap-2" title="Manage Columns">
                                        <span class="material-symbols-outlined">view_column</span>
                                        <span class="text-sm font-medium">Manage Columns</span>
                                    </button>
                                    <div id="manage-columns-popover" class="column-toggle-popover right-0 mt-2 w-60">
                                        <!-- Draggable column items will be injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- NEW: View Toggle -->
                            <div class="flex items-center space-x-1 p-1 bg-muted rounded-lg">
                                <button id="show-table-view" class="view-toggle active p-2 rounded-md leading-none" title="Table View"><span class="material-symbols-outlined">table_rows</span></button>
                                <button id="show-kanban-view" class="view-toggle p-2 rounded-md leading-none" title="Kanban View"><span class="material-symbols-outlined">view_kanban</span></button>
                            </div>
                            <button id="add-job-btn" class="bg-primary hover:bg-accent text-primary-foreground font-bold py-2 px-4 rounded-lg flex items-center whitespace-nowrap"><span class="material-symbols-outlined mr-2">add</span>Add Job</button>
                        </div>
                    </div>
                    
                    <!-- Jobs Table Container -->
                    <div id="jobs-table-container" class="bg-card rounded-lg shadow-md overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-muted">
                                <!-- Table Head will be injected by JS -->
                            </thead>
                            <tbody id="jobs-table-body" class="divide-y divide-border"></tbody>
                        </table>
                    </div>
                    <!-- NEW: Pagination Controls -->
                    <div id="pagination-controls" class="pagination-controls-container">
                        <div class="pagination-group">
                            <span class="text-sm">Items per page:</span>
                            <select id="items-per-page-select" class="editable-select text-sm w-auto !m-0 !p-1">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="pagination-group">
                            <span id="page-info" class="text-sm px-2">Page 1 of 1</span>
                            <button id="prev-page-btn" class="pagination-btn"><span class="material-symbols-outlined">chevron_left</span></button>
                            <button id="next-page-btn" class="pagination-btn"><span class="material-symbols-outlined">chevron_right</span></button>
                        </div>
                    </div>

                    <!-- NEW: Jobs Kanban Container -->
                    <div id="jobs-kanban-container" class="hidden">
                        <!-- Kanban board will be injected here by JS -->
                    </div>
                </div>
                
                <!-- Job Detail View -->
                <div id="job-detail-container" class="hidden">
                    <button id="back-to-jobs-list" class="mb-4 text-sm text-primary hover:underline flex items-center"><span class="material-symbols-outlined mr-1">arrow_back</span>Back to list</button>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="lg:w-2/3 bg-card p-6 rounded-lg shadow-md">
                            <h2 id="detail-job-title" class="text-2xl font-bold"></h2>
                            <p id="detail-job-company" class="text-lg text-muted-foreground mb-4"></p>
                            <div id="detail-job-description" class="prose max-w-none mb-4"></div>
                            <h3 class="text-lg font-semibold border-t border-border pt-4 mt-4">Notes</h3>
                            <p id="detail-job-notes" class="text-card-foreground whitespace-pre-wrap"></p>
                        </div>
                        <div class="lg:w-1/3 bg-card p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold flex items-center"><span class="material-symbols-outlined text-primary mr-2">smart_toy</span>AI Analysis</h3>
                                <div class="flex items-center space-x-3">
                                    <button id="save-ai-btn" title="Save Analysis" class="text-muted-foreground hover:text-foreground hidden"><span class="material-symbols-outlined">save</span></button>
                                    <button id="generate-ai-btn" title="Generate AI Analysis" class="text-muted-foreground hover:text-foreground"><span class="material-symbols-outlined">auto_awesome</span></button>
                                </div>
                            </div>
                            <div id="ai-detail-panel" class="space-y-4">
                                <!-- AI generated keywords will be injected here -->
                            </div>
                             <div id="ai-match-panel" class="mt-6">
                                <!-- AI match details will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profiles View -->
            <div id="profiles-view" class="view-content hidden">
                <div class="flex justify-end mb-4">
                    <button id="add-profile-btn" class="bg-primary hover:bg-accent text-primary-foreground font-bold py-2 px-4 rounded-lg flex items-center"><span class="material-symbols-outlined mr-2">add</span>Add New Profile</button>
                </div>
                <div class="bg-card rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-muted">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Profile Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Notes (Click to Edit)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Date Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="profiles-table-body" class="divide-y divide-border"></tbody>
                    </table>
                </div>
            </div>

            <!-- Companies View: REBUILT -->
            <div id="companies-view" class="view-content hidden">
                <!-- Grid View (Default) -->
                <div id="company-grid-container">
                    <div class="flex justify-between items-center mb-4 gap-4">
                        <div class="relative flex-grow">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">search</span>
                            <input type="text" id="company-search-input" placeholder="Search companies..." class="bg-input border border-border text-foreground text-sm rounded-lg focus:ring-ring focus:border-ring block w-full p-2.5 pl-10">
                        </div>
                        <button id="add-company-btn" class="bg-primary hover:bg-accent text-primary-foreground font-bold py-2 px-4 rounded-lg flex items-center whitespace-nowrap"><span class="material-symbols-outlined mr-2">add</span>Add Company</button>
                    </div>
                    <div id="company-grid" class="company-grid">
                        <!-- Company cards will be injected here -->
                    </div>
                </div>

                <!-- Company Detail View (Hidden) -->
                <div id="company-detail-container" class="hidden">
                    <button id="back-to-company-grid" class="mb-4 text-sm text-primary hover:underline flex items-center"><span class="material-symbols-outlined mr-1">arrow_back</span>Back to list</button>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Left Column: Details & AI -->
                        <div class="lg:w-1/3 space-y-6">
                            <div class="bg-card p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold mb-4">Company Details</h3>
                                <form id="edit-company-form" class="space-y-4">
                                    <input type="hidden" name="id">
                                    <div>
                                        <label class="text-sm font-medium text-muted-foreground">Name</label>
                                        <input type="text" name="name" required class="bg-input border border-border p-2 rounded-lg w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-muted-foreground">Industry</label>
                                        <input type="text" name="industry" class="bg-input border border-border p-2 rounded-lg w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-muted-foreground">Location</label>
                                        <input type="text" name="location" class="bg-input border border-border p-2 rounded-lg w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-muted-foreground">Website</label>
                                        <input type="url" name="website" class="bg-input border border-border p-2 rounded-lg w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-muted-foreground">LinkedIn</label>
                                        <input type="url" name="linkedin" class="bg-input border border-border p-2 rounded-lg w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-muted-foreground">Notes</label>
                                        <textarea name="notes" rows="4" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                                    </div>
                                    <button type="submit" class="w-full px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Save Changes</button>
                                </form>
                            </div>
                            <div class="bg-card p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold mb-4">AI Analysis</h3>
                                <button id="run-company-ai-btn" class="w-full px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg font-semibold flex items-center justify-center">
                                    <span class="material-symbols-outlined mr-2">auto_awesome</span>Generate Company Summary
                                </button>
                                <div id="company-ai-output" class="text-sm text-card-foreground mt-4 prose max-w-none">
                                    <!-- AI output will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Related Jobs -->
                        <div class="lg:w-2/3 bg-card p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Related Jobs</h3>
                            <div id="related-jobs-list" class="related-job-grid">
                                <!-- Related jobs will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- People View -->
            <div id="people-view" class="view-content hidden">
                <div class="flex justify-end mb-4">
                    <button id="add-person-btn" class="bg-primary hover:bg-accent text-primary-foreground font-bold py-2 px-4 rounded-lg flex items-center"><span class="material-symbols-outlined mr-2">add</span>Add New Contact</button>
                </div>
                <div class="bg-card rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-muted">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Job Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">LinkedIn</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Notes (Click to Edit)</th>
                            </tr>
                        </thead>
                        <tbody id="people-table-body" class="divide-y divide-border"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Logs View -->
            <div id="logs-view" class="view-content hidden">
                <div class="bg-card rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-muted">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider w-1/4">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider w-1/6">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider">Message</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body" class="divide-y divide-border"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings View: REBUILT -->
            <div id="settings-view" class="view-content hidden">
                <div class="max-w-4xl mx-auto space-y-8">
                    <h2 class="text-3xl font-bold text-center">Settings</h2>

                    <!-- Appearance Section -->
                    <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center"><span class="material-symbols-outlined mr-3 text-primary">palette</span>Appearance</h3>
                        <div class="flex items-center justify-between">
                            <label for="theme-select" class="text-sm font-medium">Theme</label>
                            <select id="theme-select" class="editable-select text-sm w-auto max-w-xs">
                                <option value="Humanist Light">Humanist Light</option>
                                <option value="Humanist Dark">Humanist Dark</option>
                            </select>
                        </div>
                    </div>

                    <!-- AI & Automation Section -->
                    <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center"><span class="material-symbols-outlined mr-3 text-primary">smart_toy</span>AI & Automation</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="llm-api-url" class="text-sm font-medium">Local LLM Endpoint</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="text" id="llm-api-url" class="bg-input border border-border text-foreground text-sm rounded-lg focus:ring-ring focus:border-ring block w-full p-2.5" placeholder="http://localhost:1234/v1/chat/completions">
                                    <button id="test-connection-btn" class_name="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">Test</button>
                                </div>
                                <p class="text-xs text-muted-foreground mt-2">See "About" section for setup instructions.</p>
                            </div>
                            <div class="flex items-center justify-between mt-4">
                                <label for="auto-create-company-toggle" class="text-sm font-medium">Auto-create new companies from jobs</label>
                                <input type="checkbox" id="auto-create-company-toggle" class="h-4 w-4 rounded border-border text-primary focus:ring-primary">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Management Section -->
                    <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center"><span class="material-symbols-outlined mr-3 text-primary">database</span>Data Management</h3>
                        <p class="text-xs text-muted-foreground bg-background p-2 rounded-md mb-4">
                            <strong>Important:</strong> All data is stored locally in your browser. Create regular manual backups for safety.
                        </p>
                        <div class="flex space-x-4">
                            <button id="backup-db-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"><span class="material-symbols-outlined mr-2">download</span>Backup DB</button>
                            <label class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer flex items-center justify-center">
                                <span class="material-symbols-outlined mr-2">upload</span>Restore DB
                                <input type="file" id="restore-db-input" class="hidden" accept=".sqlite,.db">
                            </label>
                        </div>
                    </div>

                    <!-- About Section -->
                    <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center"><span class="material-symbols-outlined mr-3 text-primary">info</span>About & Help</h3>
                        <div class="prose max-w-none">
                            <h4 class="font-semibold">How to Run Local LLM</h4>
                            <ol>
                                <li>Download & install <a href="https://lmstudio.ai/" target="_blank">LM Studio</a> for your OS.</li>
                                <li>In LM Studio, search for and download a small, fast model. We recommend: <code>gemma-2b-it-q4_0.gguf</code> (~2.5GB).</li>
                                <li>Go to the <span class="material-symbols-outlined" style="font-size: 1.2em; vertical-align: -3px;">database</span> Local Server tab, select your downloaded model, and click <strong style="color: #4ade80;">Start Server</strong>.</li>
                                <li>Copy the server URL (usually <code>http://localhost:1234/v1</code>) and paste it in the AI settings.</li>
                            </ol>
                            <h4 class="font-semibold mt-6">Credits</h4>
                            <p>This application was brought to life by <a href="https://mehtaharsh.xyz" target="_blank">Harsh Mehta</a>.<br>
                            Download App : <a>https://careerjam.mehtaharsh.xyz/download</a><br>
                            Hosted using Github & Netlify</p>
                            <p class="text-xs text-muted-foreground opacity-70 mt-4">v0.2.1 (merge-fix)</p>
                        </div>
                    </div>

                </div>
            </div>

        </main>
        
        <!-- UPDATED: Persistent Footer -->
        <footer id="status-footer" class="bg-card text-center py-1 px-4 text-sm text-muted-foreground border-t border-border z-10 transition-all duration-300">
            Status message goes here
        </footer>
    </div>

    <!-- Modals -->
    <div id="add-job-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="modal-content bg-card rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95">
            <h3 class="text-xl font-semibold mb-4">Add a New Job Post</h3>
            <form id="add-job-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="title" placeholder="Job Title" required class="bg-input border border-border p-2 rounded-lg">
                    <input type="text" name="company_name" placeholder="Company Name" required class="bg-input border border-border p-2 rounded-lg">
                    <input type="text" name="location" placeholder="Location" class="bg-input border border-border p-2 rounded-lg">
                    <input type="number" step="0.1" name="salary" placeholder="Max Salary (e.g., 15 for â‚¹15 LPA)" class="bg-input border border-border p-2 rounded-lg">
                    <input type="text" name="url" placeholder="URL for Original Posting" class="md:col-span-2 bg-input border border-border p-2 rounded-lg">
                </div>
                <div class="mt-4">
                     <textarea name="description" placeholder="Job Description" rows="8" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                </div>
                <div class="mt-4">
                    <textarea name="notes" placeholder="Notes about this job..." rows="3" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="cancel-modal-btn px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Save Job</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="add-company-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="modal-content bg-card rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95">
            <h3 class="text-xl font-semibold mb-4">Add a New Company</h3>
            <form id="add-company-form">
                 <div class="space-y-4">
                    <input type="text" name="name" placeholder="Name" required class="bg-input border border-border p-2 rounded-lg w-full">
                    <input type="text" name="industry" placeholder="Industry" class="bg-input border border-border p-2 rounded-lg w-full">
                    <input type="text" name="location" placeholder="Location" class="bg-input border border-border p-2 rounded-lg w-full">
                    <input type="url" name="website" placeholder="Website" class="bg-input border border-border p-2 rounded-lg w-full">
                    <input type="url" name="linkedin" placeholder="LinkedIn Profile" class="bg-input border border-border p-2 rounded-lg w-full">
                    <textarea name="notes" placeholder="Notes about this company..." rows="3" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="cancel-modal-btn px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Save Company</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="add-person-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="modal-content bg-card rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95">
            <h3 class="text-xl font-semibold mb-4">Add a New Contact</h3>
            <form id="add-person-form">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="first_name" placeholder="First Name" required class="bg-input border border-border p-2 rounded-lg">
                    <input type="text" name="last_name" placeholder="Last Name" required class="bg-input border border-border p-2 rounded-lg">
                    <input type="text" name="job_title" placeholder="Job Title" class="bg-input border border-border p-2 rounded-lg">
                    <input type="text" name="company_name" placeholder="Company Name" class="bg-input border border-border p-2 rounded-lg">
                    <input type="email" name="email" placeholder="Email" class="bg-input border border-border p-2 rounded-lg">
                    <input type="url" name="linkedin" placeholder="LinkedIn Profile" class="bg-input border border-border p-2 rounded-lg">
                </div>
                <div class="mt-4">
                    <textarea name="notes" placeholder="Notes about this contact..." rows="3" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="cancel-modal-btn px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Save Contact</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="modal-content bg-card rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95">
            <h3 class="text-xl font-semibold mb-4">Add New Profile</h3>
            <form id="add-profile-form">
                <div class="space-y-4">
                    <input type="text" name="name" placeholder="Profile Name (e.g., 'Senior Developer Resume')" required class="bg-input border border-border p-2 rounded-lg w-full">
                    <textarea name="content" placeholder="Paste your full resume/CV text here..." rows="12" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                    <textarea name="notes" placeholder="Notes about this profile..." rows="3" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="cancel-modal-btn px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Save Profile</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-notes-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="modal-content bg-card rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95">
            <h3 class="text-xl font-semibold mb-4">Edit Notes</h3>
            <form id="edit-notes-form">
                <input type="hidden" name="itemId">
                <input type="hidden" name="itemType">
                <textarea name="notes" id="notes-editor" rows="8" class="bg-input border border-border p-2 rounded-lg w-full"></textarea>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="cancel-modal-btn px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Save Notes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Merge Company Modal -->
    <div id="merge-company-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="modal-content bg-card rounded-lg shadow-xl p-6 w-full max-w-lg transform scale-95">
            <h3 class="text-xl font-semibold mb-4">Merge Company Entries?</h3>
            <p id="merge-company-text" class="text-card-foreground mb-6">You renamed a company. We found jobs linked to the old name. Do you want to update these jobs to the new name?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancel-merge-btn" class="cancel-modal-btn px-4 py-2 bg-secondary text-secondary-foreground hover:bg-muted rounded-lg">Cancel</button>
                <button type="button" id="confirm-merge-btn" class="px-4 py-2 bg-primary hover:bg-accent text-primary-foreground rounded-lg font-semibold">Yes, Merge</button>
            </div>
        </div>
    </div>


    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50 hidden">
        <div class="text-primary-foreground text-xl flex items-center">
            <span class="material-symbols-outlined spin mr-3">progress_activity</span>
            <span id="loading-text">Loading Database...</span>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', async () => {
    const JOB_STATUSES = ['Bookmarked', 'Applying', 'Applied', 'Interviewing', 'Negotiating', 'Accepted', 'Spam', 'Rejected'];
    let db;
    let currentJobViewStatus = 'Bookmarked';
    let currentSortOrder = 'created_at DESC';
    let currentOpenJobId = null;
    let logs = [];
    let unsavedAnalysisData = null;
    let currentJobsView = 'table'; // 'table' or 'kanban'
    
    // NEW: App state variables
    let appState = {
        autoCreateCompany: true,
        currentPage: 1,
        itemsPerPage: 10,
        theme: 'Humanist Dark', // NEW: Theme state
        // REPLACED: columnVisibility (object) with columnConfig (array) to store order
        columnConfig: [
            { key: 'title', label: 'Job Position', visible: true },
            { key: 'company_name', label: 'Company', visible: true },
            { key: 'location', label: 'Location', visible: true },
            { key: 'salary', label: 'Salary (LPA)', visible: true },
            { key: 'url', label: 'URL', visible: true },
            { key: 'description', label: 'Description', visible: false },
            { key: 'profile_id', label: 'Applied Profile', visible: true },
            { key: 'match_percentage', label: 'Match %', visible: true },
            { key: 'status', label: 'Status', visible: true },
            { key: 'notes', label: 'Notes', visible: true },
            { key: 'created_at', label: 'Date Saved', visible: true }
        ]
    };
    
    // Column definitions
    const COLUMN_DEFINITIONS = {
        title: "Job Position",
        company_name: "Company",
        location: "Location",
        salary: "Salary (LPA)",
        url: "URL",
        description: "Description",
        profile_id: "Applied Profile",
        match_percentage: "Match %",
        status: "Status",
        notes: "Notes",
        created_at: "Date Saved"
    };

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const jobsListView = document.getElementById('jobs-list-container');
    const jobDetailView = document.getElementById('job-detail-container');
    const views = document.querySelectorAll('.view-content');
    const navLinks = document.querySelectorAll('.nav-link');
    const statusFooter = document.getElementById('status-footer');
    const jobsTableBody = document.getElementById('jobs-table-body');
    const jobsTableContainer = document.getElementById('jobs-table-container');
    const jobsKanbanContainer = document.getElementById('jobs-kanban-container');
    const showTableViewBtn = document.getElementById('show-table-view');
    const showKanbanViewBtn = document.getElementById('show-kanban-view');
    const statusTabs = document.getElementById('status-tabs');
    const sortControls = document.getElementById('sort-controls');
    // NEW: Pagination elements
    const paginationControls = document.getElementById('pagination-controls');
    const itemsPerPageSelect = document.getElementById('items-per-page-select');
    const pageInfo = document.getElementById('page-info');
    const prevPageBtn = document.getElementById('prev-page-btn');
    const nextPageBtn = document.getElementById('next-page-btn');
    // NEW: Column toggle elements
    const manageColumnsBtn = document.getElementById('manage-columns-btn');
    const manageColumnsPopover = document.getElementById('manage-columns-popover');
    // NEW: Company view elements
    const companyGridContainer = document.getElementById('company-grid-container');
    const companyDetailContainer = document.getElementById('company-detail-container');
    const companyGrid = document.getElementById('company-grid');
    const companySearchInput = document.getElementById('company-search-input');
    const backToCompanyGridBtn = document.getElementById('back-to-company-grid');
    const editCompanyForm = document.getElementById('edit-company-form');
    const relatedJobsList = document.getElementById('related-jobs-list');
    // NEW: Settings elements
    const autoCreateCompanyToggle = document.getElementById('auto-create-company-toggle');
    const themeSelect = document.getElementById('theme-select');
    // NEW: Merge Modal Elements
    const mergeCompanyModal = document.getElementById('merge-company-modal');
    const mergeCompanyText = document.getElementById('merge-company-text');
    const confirmMergeBtn = document.getElementById('confirm-merge-btn');
    const cancelMergeBtn = document.getElementById('cancel-merge-btn');


    // --- Utility Functions ---
    function showLoading(text) {
        loadingText.textContent = text;
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
    }

    function hideLoading() {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
    
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('flex');
        setTimeout(() => {
            modal.querySelector('.modal-content').classList.remove('scale-95');
            modal.style.opacity = '1';
        }, 10);
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(!modal) return;
        modal.querySelector('.modal-content').classList.add('scale-95');
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.remove('flex');
            // Don't reset form if it's the merge modal
            if (modalId !== 'merge-company-modal') {
                modal.querySelector('form')?.reset();
            }
        }, 300);
    }

    function logEvent(type, message) {
        const timestamp = new Date().toISOString();
        logs.unshift({ timestamp, type, message });
        if (logs.length > 200) logs.pop(); // Keep logs from getting too big
        if (document.getElementById('logs-view').offsetParent !== null) {
            renderLogs();
        }
    }
    
    // UPDATED: Persistent Footer
    function showStatus(message, type = 'info') {
        const colors = { info: 'text-muted-foreground', success: 'text-green-400', error: 'text-destructive' };
        statusFooter.textContent = message;
        statusFooter.className = `bg-card text-center py-1 px-4 text-sm ${colors[type] || 'text-muted-foreground'} border-t border-border z-10 transition-all duration-300`;
    }

    function switchView(viewId) {
        views.forEach(view => view.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.dataset.view === viewId) {
                link.classList.add('active');
            }
        });
        if (viewId === 'jobs-view') {
            refreshJobsView(); // Refresh jobs view when switching to it
        }
        if (viewId === 'logs-view') renderLogs();
        if (viewId === 'profiles-view') renderProfiles();
        if (viewId === 'companies-view') {
            companyGridContainer.classList.remove('hidden');
            companyDetailContainer.classList.add('hidden');
            renderCompaniesGrid(); // Render company grid
        }
        logEvent('INFO', `Switched to view: ${viewId}`);
    }

    // --- App Initialization ---
    async function init() {
        showLoading('Initializing Database...');
        logEvent('INFO', 'Application initialization started.');
        try {
            const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
            const savedDb = localStorage.getItem('auto-backup-db');
            if (savedDb) {
                const Uints = new Uint8Array(savedDb.split(',').map(Number));
                db = new SQL.Database(Uints);
                logEvent('SUCCESS', 'Database loaded from auto-backup.');
            } else {
                db = new SQL.Database();
                logEvent('INFO', 'New database created.');
            }
            
            await createTables();
            loadSettings(); // Load settings early to apply theme
            renderStatusTabs();
            renderColumnToggles();
            await Promise.all([
                refreshJobsView(),
                renderCompaniesGrid(),
                renderPeople(),
                renderProfiles()
            ]);
            setupEventListeners();
            logEvent('SUCCESS', 'Application initialized successfully.');
            showStatus('Ready', 'info'); // Set initial status
        } catch (err) {
            console.error("Initialization failed:", err);
            logEvent('ERROR', `Initialization failed: ${err.message}`);
            showStatus('Initialization failed. Check logs.', 'error');
        } finally {
            hideLoading();
        }
    }

    // --- Database Logic ---
    async function createTables() {
        db.exec(`
            CREATE TABLE IF NOT EXISTS jobs (id INTEGER PRIMARY KEY, title TEXT, company_name TEXT, location TEXT, salary REAL, url TEXT, description TEXT, status TEXT DEFAULT 'Bookmarked', created_at DATETIME DEFAULT CURRENT_TIMESTAMP);
            CREATE TABLE IF NOT EXISTS companies (id INTEGER PRIMARY KEY, name TEXT UNIQUE, industry TEXT, location TEXT, website TEXT, linkedin TEXT);
            CREATE TABLE IF NOT EXISTS people (id INTEGER PRIMARY KEY, first_name TEXT, last_name TEXT, job_title TEXT, company_name TEXT, email TEXT, linkedin TEXT);
            CREATE TABLE IF NOT EXISTS profiles (id INTEGER PRIMARY KEY, name TEXT, content TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);
        `);
        
        // Safely add new columns for existing users
        const tables = ['jobs', 'companies', 'people', 'profiles'];
        tables.forEach(table => {
            const colsRes = db.exec(`PRAGMA table_info(${table})`);
            const cols = colsRes.length > 0 ? colsRes[0].values.map(col => col[1]) : [];

            if (!cols.includes('notes')) {
                db.exec(`ALTER TABLE ${table} ADD COLUMN notes TEXT`);
                logEvent('INFO', `Upgraded database: Added notes column to ${table} table.`);
            }

            // Specific columns for 'jobs' table
            if (table === 'jobs') {
                if (!cols.includes('profile_id')) {
                    db.exec("ALTER TABLE jobs ADD COLUMN profile_id INTEGER REFERENCES profiles(id)");
                    logEvent('INFO', 'Upgraded database: Added profile_id column.');
                }
                if (!cols.includes('match_percentage')) {
                    db.exec("ALTER TABLE jobs ADD COLUMN match_percentage INTEGER");
                    logEvent('INFO', 'Upgraded database: Added match_percentage column.');
                }
                if (!cols.includes('ai_keywords')) {
                    db.exec("ALTER TABLE jobs ADD COLUMN ai_keywords TEXT");
                    logEvent('INFO', 'Upgraded database: Added ai_keywords column.');
                }
                if (!cols.includes('match_justification')) {
                    db.exec("ALTER TABLE jobs ADD COLUMN match_justification TEXT");
                    logEvent('INFO', 'Upgraded database: Added match_justification column.');
                }
            }
        });
    }

    function executeQuery(sql, params = []) {
        try {
            const result = db.exec(sql, params);
            if (!sql.trim().toUpperCase().startsWith("SELECT")) {
                autoBackupDatabase();
            }
            return result;
        } catch (e) {
            console.error("DB Error:", e, "Query:", sql, "Params:", params);
            logEvent('ERROR', `DB Error: ${e.message}`);
            showStatus('Database error occurred.', 'error');
            return null;
        }
    }
    
    // --- Rendering Logic ---

    // NEW: Function to toggle between Table and Kanban views
    function toggleJobsView(view) {
        currentJobsView = view;
        if (view === 'table') {
            showTableViewBtn.classList.add('active');
            showKanbanViewBtn.classList.remove('active');
            jobsTableContainer.classList.remove('hidden');
            jobsKanbanContainer.classList.add('hidden');
            statusTabs.classList.remove('hidden');
            sortControls.classList.remove('hidden');
            paginationControls.classList.remove('hidden'); // Show pagination
            renderJobs(currentJobViewStatus);
        } else {
            showTableViewBtn.classList.remove('active');
            showKanbanViewBtn.classList.add('active');
            jobsTableContainer.classList.add('hidden');
            jobsKanbanContainer.classList.remove('hidden');
            statusTabs.classList.add('hidden');
            sortControls.classList.add('hidden');
            paginationControls.classList.add('hidden'); // Hide pagination
            renderJobsKanban();
        }
        logEvent('INFO', `Switched to ${view} view.`);
    }

    // NEW: Main function to call the correct render function
    function refreshJobsView() {
        if (currentJobsView === 'table') {
            renderJobs(currentJobViewStatus);
        } else {
            renderJobsKanban();
        }
    }

    function renderLogs() {
        const tableBody = document.getElementById('logs-table-body');
        if(!tableBody) return;
        tableBody.innerHTML = logs.map(log => {
            const typeClass = { 'INFO': 'text-blue-400', 'SUCCESS': 'text-green-400', 'ERROR': 'text-destructive' }[log.type] || 'text-muted-foreground';
            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-semibold ${typeClass}">${log.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${log.message}</td>
                </tr>`;
        }).join('');
    }

    function renderStatusTabs() {
        const tabsContainer = document.getElementById('status-tabs');
        tabsContainer.innerHTML = JOB_STATUSES.map(status => `<button class="status-tab border-b-2 border-transparent px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground transition whitespace-nowrap" data-status="${status}">${status}</button>`).join('');
        updateActiveTab();
    }
    
    function updateActiveTab() {
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.status === currentJobViewStatus);
        });
    }

    // UPDATED: renderJobs (Table View) - Now with Pagination and Column Visibility
    async function renderJobs(status) {
        // 1. Get total count for pagination
        const countRes = executeQuery(`SELECT COUNT(*) FROM jobs WHERE status = ?`, [status]);
        const totalItems = countRes[0].values[0][0];
        const totalPages = Math.ceil(totalItems / appState.itemsPerPage);
        appState.currentPage = Math.min(appState.currentPage, totalPages) || 1;
        
        renderPaginationControls(totalItems, totalPages);
        
        // 2. Get profiles for dropdown
        const profilesRes = executeQuery("SELECT id, name FROM profiles ORDER BY name");
        const profiles = profilesRes.length > 0 ? profilesRes[0].values : [];
        
        // 3. Get paginated job data
        const offset = (appState.currentPage - 1) * appState.itemsPerPage;
        const res = executeQuery(`SELECT j.id, j.title, j.company_name, j.location, j.status, j.created_at, j.profile_id, j.match_percentage, j.notes, j.salary, j.url, j.description FROM jobs j WHERE j.status = ? ORDER BY ${currentSortOrder} LIMIT ? OFFSET ?`, [status, appState.itemsPerPage, offset]);
        const jobs = res.length > 0 ? res[0].values : [];
        
        // 4. Render Table Head
        const tableHead = jobsTableContainer.querySelector('thead');
        tableHead.innerHTML = `
            <tr>
                ${appState.columnConfig.map(col => `
                    <th class="px-6 py-3 text-left text-xs font-medium text-card-foreground uppercase tracking-wider ${col.visible ? '' : 'hidden'}" data-col-key="${col.key}">
                        ${col.label}
                    </th>
                `).join('')}
            </tr>
        `;

        // 5. Render Table Body
        if (jobs.length === 0) {
            const colSpan = appState.columnConfig.filter(c => c.visible).length;
            jobsTableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-8 text-muted-foreground">No jobs in this category.</td></tr>`;
            return;
        }
        
        jobsTableBody.innerHTML = jobs.map(row => {
            const [id, title, company_name, location, currentStatus, created_at, profile_id, match_percentage, notes, salary, url, description] = row;
            const profileOptionsHtml = `<option value="">- Select Profile -</option>` + profiles.map(p => `<option value="${p[0]}" ${p[0] === profile_id ? 'selected' : ''}>${p[1]}</option>`).join('');

            // Create an object from the row data for easy access by key
            const rowData = { id, title, company_name, location, currentStatus, created_at, profile_id, match_percentage, notes, salary, url, description };
            
            return `
                <tr class="job-row" data-id="${id}">
                    ${appState.columnConfig.map(col => {
                        // Handle each cell based on its column key
                        let content = '';
                        switch(col.key) {
                            case 'title':
                            case 'company_name':
                            case 'location':
                                content = `<td class="px-6 py-4 whitespace-nowrap" data-field="details">${rowData[col.key] || 'N/A'}</td>`;
                                break;
                            case 'salary':
                                content = `<td class="px-6 py-4 whitespace-nowrap">${rowData.salary ? `â‚¹${rowData.salary} LPA` : 'N/A'}</td>`;
                                break;
                            case 'url':
                                content = `<td class="px-6 py-4 whitespace-nowrap">
                                    ${rowData.url ? `<a href="${rowData.url}" target="_blank" class="text-primary hover:underline flex items-center"><span class="material-symbols-outlined text-sm mr-1">open_in_new</span>Link</a>` : 'N/A'}
                                </td>`;
                                break;
                            case 'description':
                                content = `<td class="px-6 py-4 whitespace-nowrap max-w-xs truncate" title="${rowData.description || ''}">${(rowData.description || '').substring(0, 30)}${rowData.description && rowData.description.length > 30 ? '...' : ''}</td>`;
                                break;
                            case 'profile_id':
                                content = `<td class="px-6 py-4 whitespace-nowrap">
                                    <select data-job-id="${id}" class="profile-select editable-select text-sm">
                                        ${profileOptionsHtml}
                                    </select>
                                </td>`;
                                break;
                            case 'match_percentage':
                                content = `<td class="px-6 py-4 whitespace-nowrap text-center">
                                    <div class="flex items-center justify-center space-x-2">
                                        <span>${rowData.match_percentage === null || rowData.match_percentage === undefined ? 'N/A' : `${rowData.match_percentage}%`}</span>
                                        <button title="Run AI Match Analysis" class="analyze-match-btn text-primary hover:text-accent" data-job-id="${id}" ${!rowData.profile_id ? 'disabled' : ''}>
                                            <span class="material-symbols-outlined text-lg">biotech</span>
                                        </button>
                                    </div>
                                </td>`;
                                break;
                            case 'status':
                                content = `<td class="px-6 py-4 whitespace-nowrap" data-field="status" data-current-status="${rowData.currentStatus}">${rowData.currentStatus}</td>`;
                                break;
                            case 'notes':
                                content = `<td class="px-6 py-4 whitespace-nowrap max-w-xs truncate" data-field="notes" data-id="${id}" data-type="jobs" title="${rowData.notes || 'Click to add notes'}">${rowData.notes || ''}</td>`;
                                break;
                            case 'created_at':
                                content = `<td class="px-6 py-4 whitespace-nowrap" data-field="details">${new Date(rowData.created_at).toLocaleDateString()}</td>`;
                                break;
                        }
                        return col.visible ? content : content.replace('<td ', '<td class="hidden" ');
                    }).join('')}
                </tr>`;
        }).join('');
    }

    // NEW: Render Pagination Controls
    function renderPaginationControls(totalItems, totalPages) {
        pageInfo.textContent = `Page ${appState.currentPage} of ${totalPages || 1}`;
        prevPageBtn.disabled = appState.currentPage <= 1;
        nextPageBtn.disabled = appState.currentPage >= totalPages;
    }

    // NEW: Render Column Toggles - Now with drag and drop
    function renderColumnToggles() {
        manageColumnsPopover.innerHTML = appState.columnConfig.map((col, index) => `
            <div class="column-item" draggable="true" data-col-key="${col.key}">
                <span class="col-priority">${index + 1}</span>
                <span class="material-symbols-outlined drag-handle">drag_indicator</span>
                <label>
                    <input type="checkbox" data-col-key="${col.key}" class="h-4 w-4 rounded border-border text-primary focus:ring-primary" ${col.visible ? 'checked' : ''}>
                    <span class="text-sm">${col.label}</span>
                </label>
            </div>
        `).join('');

        // Add checkbox event listeners
        manageColumnsPopover.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const key = e.target.dataset.colKey;
                const colConfig = appState.columnConfig.find(c => c.key === key);
                if (colConfig) {
                    colConfig.visible = e.target.checked;
                }
                saveSettings(); // Save on toggle
                refreshJobsView(); // Re-render the table
            });
        });

        // Add drag/drop listeners
        setupColumnDragAndDrop();
    }
    
    // NEW: Drag and Drop for Columns
    function setupColumnDragAndDrop() {
        let draggedItem = null;

        manageColumnsPopover.querySelectorAll('.column-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                setTimeout(() => item.classList.add('dragging'), 0);
                e.dataTransfer.effectAllowed = 'move';
            });
            
            item.addEventListener('dragend', () => {
                draggedItem?.classList.remove('dragging');
                draggedItem = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                const target = e.currentTarget;
                if (target !== draggedItem && draggedItem) {
                    // Get bounding box of target
                    const rect = target.getBoundingClientRect();
                    // Get vertical center
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        target.parentNode.insertBefore(draggedItem, target);
                    } else {
                        target.parentNode.insertBefore(draggedItem, target.nextSibling);
                    }
                }
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    
                    // Update the appState.columnConfig array based on the new DOM order
                    const newConfig = [];
                    manageColumnsPopover.querySelectorAll('.column-item').forEach(el => {
                        const key = el.dataset.colKey;
                        const config = appState.columnConfig.find(c => c.key === key);
                        if (config) {
                            newConfig.push(config);
                        }
                    });
                    appState.columnConfig = newConfig;

                    // Re-render popover to update numbers and re-render table
                    renderColumnToggles(); 
                    refreshJobsView();
                    saveSettings();
                }
            });
        });
    }


    // NEW: renderJobsKanban (Kanban View) - Now with Drag-and-Drop
    async function renderJobsKanban() {
        const res = executeQuery(`SELECT id, title, company_name, match_percentage, salary, status FROM jobs ORDER BY created_at DESC`);
        
        if (!res) {
            jobsKanbanContainer.innerHTML = `<p class="text-destructive p-4">Error loading Kanban data.</p>`;
            return;
        }

        const jobs = res.length > 0 ? res[0].values : [];
        
        const jobsByStatus = JOB_STATUSES.reduce((acc, status) => {
            acc[status] = [];
            return acc;
        }, {});
        
        jobs.forEach(row => {
            const [id, title, company_name, match_percentage, salary, status] = row;
            if (jobsByStatus[status]) {
                jobsByStatus[status].push({ id, title, company_name, match_percentage, salary, status });
            }
        });

        jobsKanbanContainer.innerHTML = `
            <div class="flex space-x-4 overflow-x-auto pb-4">
                ${JOB_STATUSES.map(status => `
                    <div class="kanban-column w-72 md:w-80 flex-shrink-0">
                        <h3 class="font-semibold p-3 bg-muted rounded-t-lg flex justify-between items-center text-sm uppercase tracking-wide">
                            <span>${status}</span>
                            <span class="text-xs font-normal bg-secondary text-secondary-foreground px-2 py-0.5 rounded-full">${jobsByStatus[status].length}</span>
                        </h3>
                        <div id="kanban-col-${status}" data-status="${status}" class="kanban-dropzone space-y-3 p-3 bg-card rounded-b-lg h-full overflow-y-auto" style="min-height: 50vh;">
                            ${jobsByStatus[status].length === 0 ? `<p class="text-sm text-muted-foreground p-2">No jobs here.</p>` : ''}
                            ${jobsByStatus[status].map(job => `
                                <div class="kanban-card p-3 bg-background rounded-lg shadow-sm cursor-pointer" data-id="${job.id}" draggable="true">
                                    <h4 class="font-semibold text-sm">${job.title}</h4>
                                    <p class="text-sm text-muted-foreground">${job.company_name}</p>
                                    <div class="flex justify-between items-center mt-2 text-xs">
                                        <span class="text-muted-foreground">${job.salary ? `â‚¹${job.salary} LPA` : ''}</span>
                                        ${job.match_percentage !== null ? `<span class="font-medium ${job.match_percentage > 70 ? 'text-green-400' : 'text-muted-foreground'}">${job.match_percentage}% Match</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // Add drag-and-drop listeners
        setupDragAndDrop();
    }

    // NEW: Drag and Drop Logic
    function setupDragAndDrop() {
        let draggedItemId = null;

        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', e => {
                draggedItemId = e.target.dataset.id;
                setTimeout(() => e.target.classList.add('opacity-50'), 0);
            });

            card.addEventListener('dragend', e => {
                draggedItemId = null;
                e.target.classList.remove('opacity-50');
            });
        });

        document.querySelectorAll('.kanban-dropzone').forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault(); // Allow drop
                zone.classList.add('bg-muted');
            });

            zone.addEventListener('dragleave', e => {
                zone.classList.remove('bg-muted');
            });

            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('bg-muted');
                const newStatus = zone.dataset.status;
                
                if (draggedItemId && newStatus) {
                    // Update DB
                    executeQuery("UPDATE jobs SET status = ? WHERE id = ?", [newStatus, draggedItemId]);
                    logEvent('INFO', `Dragged job ID ${draggedItemId} to ${newStatus}`);
                    
                    // Optimistically update UI
                    const draggedCard = document.querySelector(`.kanban-card[data-id="${draggedItemId}"]`);
                    if(draggedCard) {
                        zone.appendChild(draggedCard);
                    } else {
                        renderJobsKanban(); // Fallback to full re-render
                    }
                }
            });
        });
    }


    async function renderProfiles() {
        const tableBody = document.getElementById('profiles-table-body');
        const res = executeQuery("SELECT id, name, created_at, notes FROM profiles ORDER BY created_at DESC");
        const profiles = res.length > 0 ? res[0].values : [];
        if (profiles.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-muted-foreground">No profiles created yet.</td></tr>`;
            return;
        }
        tableBody.innerHTML = profiles.map(row => {
            const [id, name, created_at, notes] = row;
            return `
                <tr class="hover:bg-muted">
                    <td class="px-6 py-4 whitespace-nowrap">${name}</td>
                    <td class="px-6 py-4 whitespace-nowrap max-w-xs truncate" data-field="notes" data-id="${id}" data-type="profiles" title="${notes || 'Click to add notes'}">${notes || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(created_at).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="delete-profile-btn text-destructive hover:opacity-70" data-id="${id}"><span class="material-symbols-outlined">delete</span></button>
                    </td>
                </tr>`}).join('');
    }

    // UPDATED: renderCompanies to renderCompaniesGrid
    async function renderCompaniesGrid() {
        const searchTerm = companySearchInput.value.toLowerCase();
        const res = executeQuery("SELECT id, name, industry, location FROM companies ORDER BY name");
        const companies = res.length > 0 ? res[0].values : [];
        
        const filteredCompanies = companies.filter(([id, name, industry, location]) => 
            name.toLowerCase().includes(searchTerm) || 
            (industry || '').toLowerCase().includes(searchTerm) || 
            (location || '').toLowerCase().includes(searchTerm)
        );
        
        if (filteredCompanies.length === 0) {
            companyGrid.innerHTML = `<p class="text-muted-foreground">No companies found.</p>`;
            return;
        }

        companyGrid.innerHTML = filteredCompanies.map(([id, name, industry, location]) => `
            <div class="company-card" data-id="${id}">
                <h3 class="font-semibold text-lg">${name}</h3>
                <p class="text-sm text-muted-foreground">${industry || 'No industry'}</p>
                <p class="text-sm text-muted-foreground mt-1 flex items-center">
                    <span class="material-symbols-outlined text-sm mr-1">location_on</span>
                    ${location || 'No location'}
                </p>
            </div>
        `).join('');

        // Add click listeners
        companyGrid.querySelectorAll('.company-card').forEach(card => {
            card.addEventListener('click', () => {
                showCompanyDetail(card.dataset.id);
            });
        });
    }

    // NEW: Show Company Detail Page
    async function showCompanyDetail(companyId) {
        companyGridContainer.classList.add('hidden');
        companyDetailContainer.classList.remove('hidden');

        // 1. Fetch and populate company details
        const res = executeQuery("SELECT id, name, industry, location, website, linkedin, notes FROM companies WHERE id = ?", [companyId]);
        if (!res || res.length === 0) return;
        
        const [id, name, industry, location, website, linkedin, notes] = res[0].values[0];
        editCompanyForm.elements.id.value = id;
        editCompanyForm.elements.name.value = name;
        editCompanyForm.elements.industry.value = industry || '';
        editCompanyForm.elements.location.value = location || '';
        editCompanyForm.elements.website.value = website || '';
        editCompanyForm.elements.linkedin.value = linkedin || '';
        editCompanyForm.elements.notes.value = notes || '';

        // 2. Fetch and render related jobs
        const profilesRes = executeQuery("SELECT id, name FROM profiles");
        const profilesMap = profilesRes.length > 0 ? profilesRes[0].values.reduce((acc, [id, name]) => {
            acc[id] = name;
            return acc;
        }, {}) : {};

        const jobsRes = executeQuery("SELECT id, title, status, location, salary, created_at, match_percentage, profile_id FROM jobs WHERE company_name = ? ORDER BY created_at DESC", [name]);
        const jobs = jobsRes.length > 0 ? jobsRes[0].values : [];

        if (jobs.length === 0) {
            relatedJobsList.innerHTML = `<p class="text-muted-foreground">No jobs found for this company.</p>`;
        } else {
            // UPDATED: To render grid of cards with requested fields
            relatedJobsList.innerHTML = jobs.map(([jobId, title, status, location, salary, created_at, match_percentage, profile_id]) => `
                <div class="related-job-card">
                    <div class="flex justify-between items-start">
                        <h4 class="text-sm" data-job-id="${jobId}">${title}</h4>
                        <span class="text-xs font-medium bg-secondary text-secondary-foreground px-2 py-0.5 rounded-full whitespace-nowrap">${status}</span>
                    </div>
                    <p><span class="material-symbols-outlined !text-sm">location_on</span> ${location || 'N/A'}</p>
                    <p><span class="material-symbols-outlined !text-sm">paid</span> ${salary ? `â‚¹${salary} LPA` : 'N/A'}</p>
                    <p><span class="material-symbols-outlined !text-sm">badge</span> ${profilesMap[profile_id] || 'N/A'}</p>
                    <p><span class="material-symbols-outlined !text-sm">percent</span> ${match_percentage !== null ? `${match_percentage}% Match` : 'N/A'}</p>
                    <p><span class="material-symbols-outlined !text-sm">calendar_today</span> ${new Date(created_at).toLocaleDateString()}</p>
                </div>
            `).join('');

            // Add click listeners to job titles
            relatedJobsList.querySelectorAll('h4[data-job-id]').forEach(titleEl => {
                titleEl.addEventListener('click', () => {
                    switchView('jobs-view'); // Switch to main jobs view
                    showJobDetail(titleEl.dataset.jobId); // Open the detail modal
                });
            });
        }
        
        // Clear AI output
        document.getElementById('company-ai-output').innerHTML = '';
    }

    // UPDATED: Handle Company Form Submit with Merge Logic
    async function handleEditCompany(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        
        // 1. Get the old name *before* updating
        const oldNameRes = executeQuery("SELECT name FROM companies WHERE id = ?", [data.id]);
        if (!oldNameRes || oldNameRes.length === 0) {
             logEvent('ERROR', `Could not find company with ID ${data.id} to update.`);
             showStatus('Error updating company.', 'error');
             return;
        }
        const oldName = oldNameRes[0].values[0][0];

        // 2. Update the company
        executeQuery("UPDATE companies SET name = ?, industry = ?, location = ?, website = ?, linkedin = ?, notes = ? WHERE id = ?", 
            [data.name, data.industry, data.location, data.website, data.linkedin, data.notes, data.id]);
        
        logEvent('SUCCESS', `Updated company: ${data.name}`);
        showStatus('Company updated successfully!', 'success');
        
        // 3. If name changed, check for jobs with old name and ask to merge
        if (oldName !== data.name) {
            const jobsRes = executeQuery("SELECT id FROM jobs WHERE company_name = ?", [oldName]);
            const jobsToMerge = jobsRes.length > 0 ? jobsRes[0].values : [];
            if (jobsToMerge.length > 0) {
                openMergeModal(oldName, data.name, jobsToMerge.length);
            }
        }
        
        await renderCompaniesGrid(); // Refresh grid
    }

    // NEW: Open Merge Modal
    function openMergeModal(oldName, newName, count) {
        mergeCompanyText.innerHTML = `You renamed "<strong>${oldName}</strong>" to "<strong>${newName}</strong>".<br>We found <strong>${count}</strong> job(s) linked to the old name. Do you want to update them?`;
        
        // Use .onclick to ensure we only have one listener
        confirmMergeBtn.onclick = () => {
            confirmMergeCompany(oldName, newName);
        };
        cancelMergeBtn.onclick = () => {
            closeModal('merge-company-modal');
        };

        openModal('merge-company-modal');
    }

    // NEW: Confirm Merge Function
    function confirmMergeCompany(oldName, newName) {
        executeQuery("UPDATE jobs SET company_name = ? WHERE company_name = ?", [newName, oldName]);
        logEvent('INFO', `Merged ${oldName} into ${newName}.`);
        showStatus(`Successfully merged jobs into ${newName}.`, 'success');
        closeModal('merge-company-modal');
        // Refresh related jobs if user is still on the detail page
        if (!companyDetailContainer.classList.contains('hidden')) {
            showCompanyDetail(editCompanyForm.elements.id.value);
        }
    }


    async function renderPeople() {
        const tableBody = document.getElementById('people-table-body');
        const res = executeQuery("SELECT id, first_name, last_name, job_title, company_name, email, linkedin, notes FROM people ORDER BY last_name");
        const people = res.length > 0 ? res[0].values : [];
        tableBody.innerHTML = people.map(row => {
            const [id, first_name, last_name, job_title, company_name, email, linkedin, notes] = row;
            return `
                <tr class="hover:bg-muted">
                    <td class="px-6 py-4 whitespace-nowrap">${first_name} ${last_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${job_title || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${company_name || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${email || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><a href="${linkedin}" target="_blank" class="text-primary hover:underline">${linkedin || ''}</a></td>
                    <td class="px-6 py-4 whitespace-nowrap max-w-xs truncate" data-field="notes" data-id="${id}" data-type="people" title="${notes || 'Click to add notes'}">${notes || ''}</td>
                </tr>`}).join('');
    }

    async function showJobDetail(jobId) {
        currentOpenJobId = jobId;
        const res = executeQuery("SELECT title, company_name, description, notes, profile_id, match_percentage, ai_keywords, match_justification FROM jobs WHERE id = ?", [jobId]);
        if (!res || res.length === 0) {
            logEvent('ERROR', `Could not find job with ID ${jobId}`);
            return;
        }
        
        const [title, company, description, notes, profile_id, match_percentage, ai_keywords, match_justification] = res[0].values[0];
        
        document.getElementById('detail-job-title').textContent = title;
        document.getElementById('detail-job-company').textContent = company;
        document.getElementById('detail-job-description').innerHTML = description ? description.replace(/\n/g, '<br>') : 'No description provided.';
        document.getElementById('detail-job-notes').textContent = notes || 'No notes for this job.';
        
        document.getElementById('save-ai-btn').classList.add('hidden');
        unsavedAnalysisData = null;

        if (ai_keywords) {
            try { renderKeywords(JSON.parse(ai_keywords)); } 
            catch (e) {
                logEvent('ERROR', `Failed to parse saved keywords for JobID ${jobId}`);
                document.getElementById('ai-detail-panel').innerHTML = `<p class="text-destructive text-sm">Could not load saved analysis.</p>`;
            }
        } else {
            document.getElementById('ai-detail-panel').innerHTML = `<p class="text-muted-foreground text-sm">Click the âœ¨ button to generate keyword analysis.</p>`;
        }

        if (match_percentage !== null && match_justification) {
            renderMatchAnalysis({ match_percentage, justification: match_justification });
        } else if (profile_id) {
            document.getElementById('ai-match-panel').innerHTML = `<p class="text-muted-foreground text-sm">Click the âœ¨ button to generate a profile match analysis.</p>`;
        } else {
            document.getElementById('ai-match-panel').innerHTML = `<p class="text-muted-foreground text-sm">Select a profile from the main list to enable match analysis.</p>`;
        }

        jobsListView.classList.add('hidden');
        jobDetailView.classList.remove('hidden');
    }
    
    // --- Event Handlers ---
    function setupEventListeners() {
        navLinks.forEach(link => link.addEventListener('click', (e) => switchView(e.currentTarget.dataset.view)));
        ['add-job-btn', 'add-profile-btn', 'add-company-btn', 'add-person-btn'].forEach(id => {
            document.getElementById(id).addEventListener('click', () => openModal(id.replace('-btn', '-modal')));
        });
        document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal').id)));
        
        statusTabs.addEventListener('click', e => {
            if (e.target.classList.contains('status-tab')) {
                currentJobViewStatus = e.target.dataset.status;
                updateActiveTab();
                renderJobs(currentJobViewStatus);
            }
        });
        
        document.getElementById('sort-jobs-select').addEventListener('change', e => {
            currentSortOrder = e.target.value;
            logEvent('INFO', `Changed job sort order to: ${e.target.options[e.target.selectedIndex].text}`);
            renderJobs(currentJobViewStatus);
        });

        // Event listener for Table view
        jobsTableBody.addEventListener('click', e => {
            const cell = e.target.closest('td');
            if (cell && cell.dataset.field === 'details') {
                const row = cell.closest('.job-row');
                if(row) showJobDetail(row.dataset.id);
            }
            
            const analyzeBtn = e.target.closest('.analyze-match-btn');
            if (analyzeBtn) {
                 const jobId = analyzeBtn.dataset.jobId;
                 const profileSelect = analyzeBtn.closest('tr').querySelector('.profile-select');
                 if(profileSelect.value){
                      handleAnalyzeMatchFromList(jobId, profileSelect.value);
                 } else {
                      showStatus("Please select a profile first.", "error");
                 }
            }
        });
        
        jobsTableBody.addEventListener('change', async e => {
            if (e.target.classList.contains('profile-select')) {
                const jobId = e.target.dataset.jobId;
                const profileId = e.target.value;
                executeQuery("UPDATE jobs SET profile_id = ?, match_percentage = NULL, match_justification = NULL WHERE id = ?", [profileId || null, jobId]);
                logEvent('INFO', `Set profile to ID ${profileId || 'None'} for job ID ${jobId}.`);
                const analyzeBtn = e.target.closest('tr').querySelector('.analyze-match-btn');
                analyzeBtn.disabled = !profileId;
                await renderJobs(currentJobViewStatus);
            }
        });

        jobsTableBody.addEventListener('dblclick', e => {
            const cell = e.target.closest('td');
            if (cell && cell.dataset.field === 'status') makeStatusEditable(cell);
        });

        // NEW: Event listener for Kanban view
        jobsKanbanContainer.addEventListener('click', e => {
            const card = e.target.closest('.kanban-card');
            if (card) {
                showJobDetail(card.dataset.id);
            }
        });

        // NEW: View Toggle Buttons
        showTableViewBtn.addEventListener('click', () => toggleJobsView('table'));
        showKanbanViewBtn.addEventListener('click', () => toggleJobsView('kanban'));

        // NEW: Pagination listeners
        prevPageBtn.addEventListener('click', () => {
            if (appState.currentPage > 1) {
                appState.currentPage--;
                renderJobs(currentJobViewStatus);
            }
        });
        nextPageBtn.addEventListener('click', () => {
            appState.currentPage++; // renderJobs will cap this if it's too high
            renderJobs(currentJobViewStatus);
        });
        itemsPerPageSelect.addEventListener('change', (e) => {
            appState.itemsPerPage = parseInt(e.target.value, 10);
            appState.currentPage = 1; // Reset to first page
            renderJobs(currentJobViewStatus);
        });

        // NEW: Column toggle popover listener
        manageColumnsBtn.addEventListener('click', () => {
            manageColumnsPopover.classList.toggle('show');
        });
        // Close popover if clicking outside
        document.addEventListener('click', (e) => {
            if (!manageColumnsBtn.contains(e.target) && !manageColumnsPopover.contains(e.target)) {
                manageColumnsPopover.classList.remove('show');
            }
        });


        document.getElementById('profiles-table-body').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-profile-btn');
            // Replaced confirm() with a simple true
            if (deleteBtn && true) { // Bypassed confirm()
                const profileId = deleteBtn.dataset.id;
                executeQuery("DELETE FROM profiles WHERE id = ?", [profileId]);
                logEvent('SUCCESS', `Deleted profile ID ${profileId}`);
                showStatus('Profile deleted.', 'success');
                renderProfiles();
                refreshJobsView(); // Refresh jobs view in case profile was used
            }
        });
        
        document.getElementById('back-to-jobs-list').addEventListener('click', () => {
             jobDetailView.classList.add('hidden');
             jobsListView.classList.remove('hidden');
             refreshJobsView(); // Use new refresh function
        });

        document.getElementById('generate-ai-btn').addEventListener('click', generateAndDisplayFullAnalysis);
        document.getElementById('save-ai-btn').addEventListener('click', handleSaveAnalysis);
        
        document.getElementById('add-job-form').addEventListener('submit', handleAddJob);
        document.getElementById('add-profile-form').addEventListener('submit', handleAddProfile);
        document.getElementById('add-company-form').addEventListener('submit', handleAddCompany);
        document.getElementById('add-person-form').addEventListener('submit', handleAddPerson);
        document.getElementById('edit-notes-form').addEventListener('submit', handleEditNotes);
        // NEW: Company view listeners
        companySearchInput.addEventListener('input', renderCompaniesGrid);
        backToCompanyGridBtn.addEventListener('click', () => {
            companyDetailContainer.classList.add('hidden');
            companyGridContainer.classList.remove('hidden');
            renderCompaniesGrid(); // Refresh grid in case names changed
        });
        editCompanyForm.addEventListener('submit', handleEditCompany);

        
        document.querySelector('main').addEventListener('click', e => {
            const notesCell = e.target.closest('td[data-field="notes"]');
            if (notesCell) {
                openNotesEditor(notesCell);
            }
        });

        // UPDATED: Settings Listeners
        document.getElementById('llm-api-url').addEventListener('change', saveSettings);
        autoCreateCompanyToggle.addEventListener('change', saveSettings);
        themeSelect.addEventListener('change', () => {
            applyTheme(themeSelect.value);
            saveSettings();
        });
        document.getElementById('test-connection-btn').addEventListener('click', testLLMConnection);
        document.getElementById('backup-db-btn').addEventListener('click', downloadBackup);
        document.getElementById('restore-db-input').addEventListener('change', restoreDatabase);
    }
    
    function openNotesEditor(cell) {
        const id = cell.dataset.id;
        const type = cell.dataset.type;
        const currentNotes = cell.title.replace('Click to add notes', ''); // Use title to get full notes

        const form = document.getElementById('edit-notes-form');
        form.elements.itemId.value = id;
        form.elements.itemType.value = type;
        form.elements.notes.value = currentNotes;
        
        openModal('edit-notes-modal');
    }

    async function handleEditNotes(e) {
        e.preventDefault();
        const form = e.target;
        const id = form.elements.itemId.value;
        const type = form.elements.itemType.value;
        const notes = form.elements.notes.value;

        if (!id || !type) {
            showStatus("Error saving notes: missing data.", "error");
            return;
        }

        executeQuery(`UPDATE ${type} SET notes = ? WHERE id = ?`, [notes, id]);
        logEvent('SUCCESS', `Updated notes for ${type} ID ${id}.`);
        showStatus('Notes updated successfully!', 'success');

        closeModal('edit-notes-modal');

        switch (type) {
            case 'jobs':
                await refreshJobsView();
                break;
            case 'profiles':
                await renderProfiles();
                break;
            case 'companies':
                await renderCompanies(); // This function might need to be renderCompaniesGrid()
                break;
            case 'people':
                await renderPeople();
                break;
        }
    }

    async function handleAddJob(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());

        // NEW: Auto-create company logic
        if (appState.autoCreateCompany && data.company_name) {
            try {
                const res = executeQuery("SELECT id FROM companies WHERE name = ?", [data.company_name]);
                if (res.length === 0 || res[0].values.length === 0) {
                    executeQuery("INSERT INTO companies (name) VALUES (?)", [data.company_name]);
                    logEvent('INFO', `Auto-created new company: ${data.company_name}`);
                }
            } catch (err) {
                logEvent('ERROR', `Failed to auto-create company: ${err.message}`);
            }
        }

        executeQuery("INSERT INTO jobs (title, company_name, location, salary, url, description, status, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?)", [data.title, data.company_name, data.location, data.salary || null, data.url, data.description, 'Bookmarked', data.notes]);
        logEvent('SUCCESS', `Added new job: ${data.title}`);
        showStatus('Job saved successfully!', 'success');
        await refreshJobsView();
        closeModal('add-job-modal');
    }

    async function handleAddProfile(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        if(!data.name || !data.content) {
            showStatus("Profile Name and Content are required.", "error"); return;
        }
        executeQuery("INSERT INTO profiles (name, content, notes) VALUES (?, ?, ?)", [data.name, data.content, data.notes]);
        logEvent('SUCCESS', `Added new profile: ${data.name}`);
        showStatus('Profile saved!', 'success');
        await renderProfiles();
        closeModal('add-profile-modal');
    }

     async function handleAddCompany(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        executeQuery("INSERT OR IGNORE INTO companies (name, industry, location, website, linkedin, notes) VALUES (?, ?, ?, ?, ?, ?)", [data.name, data.industry, data.location, data.website, data.linkedin, data.notes]);
        logEvent('SUCCESS', `Added company: ${data.name}`);
        showStatus('Company saved!', 'success');
        await renderCompaniesGrid(); // Refresh grid
        closeModal('add-company-modal');
    }

    async function handleAddPerson(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        executeQuery("INSERT INTO people (first_name, last_name, job_title, company_name, email, linkedin, notes) VALUES (?, ?, ?, ?, ?, ?, ?)", [data.first_name, data.last_name, data.job_title, data.company_name, data.email, data.linkedin, data.notes]);
        logEvent('SUCCESS', `Added contact: ${data.first_name} ${data.last_name}`);
        showStatus('Contact saved!', 'success');
        await renderPeople();
        closeModal('add-person-modal');
    }

    function makeStatusEditable(cell) {
        const currentStatus = cell.dataset.currentStatus;
        cell.innerHTML = `<select class="editable-select text-sm">${JOB_STATUSES.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`).join('')}</select>`;
        const select = cell.querySelector('select');
        select.focus();
        const saveChange = () => {
            const newStatus = select.value;
            const jobId = cell.closest('.job-row').dataset.id;
            executeQuery("UPDATE jobs SET status = ? WHERE id = ?", [newStatus, jobId]);
            logEvent('INFO', `Updated status for job ID ${jobId} to ${newStatus}`);
            showStatus('Status updated.', 'success');
            renderJobs(currentJobViewStatus); // Re-render the jobs list
        };
        select.addEventListener('blur', saveChange);
        select.addEventListener('change', saveChange);
    }

    // --- Auto Backup & Persistence ---
    function autoBackupDatabase() {
        try {
            const data = db.export();
            localStorage.setItem('auto-backup-db', data.join(','));
        } catch (e) {
            logEvent('ERROR', `Auto-backup failed: ${e.message}`);
        }
    }
    
    function downloadBackup() {
        const blob = new Blob([db.export()], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `job_tracker_backup_${Date.now()}.sqlite`;
        a.click();
        URL.revokeObjectURL(url);
        logEvent('SUCCESS', 'Manual database backup created.');
        showStatus('Backup file downloaded.', 'success');
    }

    // NEW: Apply Theme Function
    function applyTheme(themeName) {
        if (themeName === 'Humanist Dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        appState.theme = themeName;
    }

    function saveSettings() {
        const apiUrl = document.getElementById('llm-api-url').value;
        appState.autoCreateCompany = autoCreateCompanyToggle.checked;
        appState.theme = themeSelect.value; // Save theme
        
        const settings = {
            llmApiUrl: apiUrl,
            autoCreateCompany: appState.autoCreateCompany,
            itemsPerPage: appState.itemsPerPage, // Save pagination setting
            columnConfig: appState.columnConfig, // Save NEW column config
            theme: appState.theme // Save theme
        };
        localStorage.setItem('jobTrackerSettings', JSON.stringify(settings));
        logEvent('SUCCESS', 'Settings saved.');
        showStatus('Settings saved!', 'success');
    }

    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('jobTrackerSettings'));
        if (settings) {
            if (settings.llmApiUrl) {
                document.getElementById('llm-api-url').value = settings.llmApiUrl;
            }
            appState.autoCreateCompany = settings.autoCreateCompany !== false; // default to true
            autoCreateCompanyToggle.checked = appState.autoCreateCompany;

            // Load theme
            appState.theme = settings.theme || 'Humanist Dark';
            themeSelect.value = appState.theme;
            applyTheme(appState.theme);

            // Load pagination and column settings
            appState.itemsPerPage = settings.itemsPerPage || 10;
            itemsPerPageSelect.value = appState.itemsPerPage;
            
            // NEW: Load columnConfig
            if (settings.columnConfig) {
                appState.columnConfig = settings.columnConfig;
                // Ensure all keys from COLUMN_DEFINITIONS exist in the loaded config
                const loadedKeys = appState.columnConfig.map(c => c.key);
                Object.keys(COLUMN_DEFINITIONS).forEach(key => {
                    if (!loadedKeys.includes(key)) {
                        appState.columnConfig.push({
                            key: key,
                            label: COLUMN_DEFINITIONS[key],
                            visible: false // Default new columns to hidden
                        });
                    }
                });
                // Ensure all labels are up-to-date
                appState.columnConfig.forEach(col => {
                    col.label = COLUMN_DEFINITIONS[col.key];
                });
            }
        }
        
        // Load legacy visibility settings if they exist and convert them
        const legacyColumnVisibility = JSON.parse(localStorage.getItem('jobTrackerColumnVisibility'));
        if (legacyColumnVisibility) {
            // This is the old format (object of booleans)
            // We just update the 'visible' property in our new array structure
            appState.columnConfig.forEach(col => {
                if (legacyColumnVisibility[col.key] !== undefined) {
                    col.visible = legacyColumnVisibility[col.key];
                }
            });
            localStorage.removeItem('jobTrackerColumnVisibility'); // Remove old key
            saveSettings(); // Re-save under new structure
        }
    }
    
    async function restoreDatabase(event) {
        const file = event.target.files[0];
        if (!file) return;
        // Bypassed confirm for iframe compatibility
        showLoading('Restoring Database...');
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                db = new SQL.Database(new Uint8Array(e.target.result));
                autoBackupDatabase();
                await init();
                logEvent('SUCCESS', `Database restored from file: ${file.name}`);
                showStatus('Database restored successfully!', 'success');
                switchView('jobs-view');
            } catch (err) {
                console.error("Restore failed:", err);
                logEvent('ERROR', `Database restore failed: ${err.message}`);
                showStatus('Database restore failed.', 'error');
            } finally {
                hideLoading();
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- AI Integration ---
     async function testLLMConnection() {
        const apiUrl = document.getElementById('llm-api-url')?.value;
        if (!apiUrl) { showStatus('Please enter an API Endpoint URL first.', 'error'); return; }
        const btn = document.getElementById('test-connection-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="material-symbols-outlined spin">progress_activity</span>`;
        showStatus('Testing connection...', 'info');
        logEvent('INFO', `Testing LLM connection to ${apiUrl}`);
        try {
            const response = await fetch(apiUrl, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: "local-model", messages: [{ role: "user", content: "Say 'Hello'" }]})
            });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const result = await response.json();
            if (result.choices && result.choices[0]) {
                showStatus('Connection successful!', 'success');
                logEvent('SUCCESS', 'LLM connection test was successful.');
            } else { throw new Error('Invalid response format from server.'); }
        } catch (error) {
            console.error("LLM Connection Test Error:", error);
            showStatus(`Connection failed. Check logs.`, 'error');
            logEvent('ERROR', `LLM connection test failed: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Test';
        }
    }

    async function callLLM(prompt, content) {
        const apiUrl = document.getElementById('llm-api-url')?.value;
        if (!apiUrl) throw new Error("LLM API Endpoint not set in Settings.");
        const response = await fetch(apiUrl, {
            method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: "local-model", messages: [{ role: "user", content: `${prompt}\n\n---\n\n${content}` }], stream: false })
        });
        if (!response.ok) throw new Error(`API error: ${response.statusText}`);
        const result = await response.json();
        let llmContent = result.choices[0]?.message?.content;

        if (llmContent) {
            llmContent = llmContent.replace(/```json/g, '').replace(/```/g, '').trim();
        }

        return llmContent;
    }

    async function runKeywordsAnalysis(description) {
        const prompt = `Based on the following job description, extract key skills and technologies. Categorize them under 'Requirements', 'Responsibilities', and 'Preferred'. Provide the output as a single, minified JSON object with no extra text or markdown. Example: {"Requirements":["Skill A","Skill B"],"Responsibilities":["Task C","Task D"],"Preferred":["Tool E"]}`;
        const content = await callLLM(prompt, description);
        return JSON.parse(content);
    }

    async function runMatchAnalysis(jobDescription, profileContent) {
        const prompt = `Analyze the following resume against the job description. Provide a percentage match score (0-100) and a brief, one-sentence justification. Return a single, minified JSON object with keys "match_percentage" and "justification". Example: {"match_percentage":85,"justification":"Strong match in key skills, but lacks preferred experience."}`;
        const combinedContent = `[RESUME]\n${profileContent}\n\n[JOB DESCRIPTION]\n${jobDescription}`;
        const content = await callLLM(prompt, combinedContent);
        return JSON.parse(content);
    }

    async function handleAnalyzeMatchFromList(jobId, profileId) {
        showStatus(`Analyzing match for job...`, 'info');
        logEvent('INFO', `Starting AI profile match for JobID: ${jobId} & ProfileID: ${profileId}`);
        try {
            const jobRes = executeQuery("SELECT description FROM jobs WHERE id = ?", [jobId]);
            const profileRes = executeQuery("SELECT content FROM profiles WHERE id = ?", [profileId]);
            const jobDescription = jobRes[0].values[0][0];
            const profileContent = profileRes[0].values[0][0];
            if (!jobDescription || !profileContent) { showStatus("Job/profile content is empty.", "error"); return; }
            const { match_percentage, justification } = await runMatchAnalysis(jobDescription, profileContent);
            executeQuery("UPDATE jobs SET match_percentage = ?, match_justification = ? WHERE id = ?", [match_percentage, justification, jobId]);
            logEvent('SUCCESS', `AI match for JobID ${jobId} is ${match_percentage}%.`);
            showStatus(`AI Match: ${match_percentage}%`, 'success');
            await renderJobs(currentJobViewStatus);
        } catch (error) {
            console.error("LLM Match Error (List View):", error);
            logEvent('ERROR', `LLM Match Error (List View): ${error.message}`);
            showStatus('AI match analysis failed.', 'error');
        }
    }

    async function generateAndDisplayFullAnalysis() {
        if (!currentOpenJobId) return;
        const generateBtn = document.getElementById('generate-ai-btn');
        generateBtn.disabled = true;
        generateBtn.innerHTML = `<span class="material-symbols-outlined spin">progress_activity</span>`;
        const [description, profile_id] = executeQuery("SELECT description, profile_id FROM jobs WHERE id = ?", [currentOpenJobId])[0].values[0];
        const keywordsPanel = document.getElementById('ai-detail-panel');
        const matchPanel = document.getElementById('ai-match-panel');
        keywordsPanel.innerHTML = `<div class="text-center"><span class="material-symbols-outlined spin mr-2">progress_activity</span>Analyzing keywords...</div>`;
        if (profile_id) { matchPanel.innerHTML = `<div class="text-center mt-4"><span class="material-symbols-outlined spin mr-2">progress_activity</span>Analyzing match...</div>`; }
        try {
            const analysisPromises = [runKeywordsAnalysis(description)];
            if (profile_id) {
                const profileContent = executeQuery("SELECT content FROM profiles WHERE id = ?", [profile_id])[0].values[0][0];
                analysisPromises.push(runMatchAnalysis(description, profileContent));
            }
            const [keywordsResult, matchResult] = await Promise.all(analysisPromises);
            unsavedAnalysisData = { keywords: keywordsResult, match: matchResult || null };
            renderKeywords(keywordsResult);
            if (matchResult) renderMatchAnalysis(matchResult);
            document.getElementById('save-ai-btn').classList.remove('hidden');
            showStatus('AI analysis generated. Click Save to keep it.', 'success');
            logEvent('SUCCESS', `Generated new AI analysis for JobID ${currentOpenJobId}`);
        } catch(error) {
            console.error("Full Analysis Error:", error);
            logEvent('ERROR', `Full analysis failed: ${error.message}`);
            showStatus('AI analysis failed. Check logs.', 'error');
            keywordsPanel.innerHTML = `<p class="text-destructive text-sm">Keyword analysis failed.</p>`;
            if (profile_id) matchPanel.innerHTML = `<p class="text-destructive text-sm">Match analysis failed.</p>`;
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = `<span class="material-symbols-outlined">auto_awesome</span>`;
        }
    }
    
    async function handleSaveAnalysis() {
        if (!unsavedAnalysisData || !currentOpenJobId) { showStatus('No analysis data to save.', 'error'); return; }
        const { keywords, match } = unsavedAnalysisData;
        executeQuery("UPDATE jobs SET ai_keywords = ?, match_percentage = ?, match_justification = ? WHERE id = ?", 
            [JSON.stringify(keywords), match ? match.match_percentage : null, match ? match.justification : null, currentOpenJobId]);
        logEvent('SUCCESS', `Saved AI analysis for JobID ${currentOpenJobId}`);
        showStatus('AI analysis saved successfully!', 'success');
        document.getElementById('save-ai-btn').classList.add('hidden');
        unsavedAnalysisData = null;
    }

    function renderKeywords(data) {
        const panel = document.getElementById('ai-detail-panel');
        panel.innerHTML = '';
        const categoryOrder = ['Requirements', 'Responsibilities', 'Preferred'];
        let contentExists = false;
        for(const category of categoryOrder){
            if(data[category] && data[category].length > 0) {
                contentExists = true;
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h4 class="font-semibold text-muted-foreground text-sm mb-2">${category}</h4>`;
                const tagContainer = document.createElement('div');
                tagContainer.className = 'flex flex-wrap gap-2';
                data[category].forEach(keyword => {
                    const tag = document.createElement('span');
                    tag.className = 'bg-primary bg-opacity-30 text-primary text-opacity-90 text-xs font-medium px-2.5 py-1 rounded-full';
                    tag.textContent = keyword;
                    tagContainer.appendChild(tag);
                });
                categoryDiv.appendChild(tagContainer);
                panel.appendChild(categoryDiv);
            }
        }
        if (!contentExists) {
            panel.innerHTML = `<p class="text-muted-foreground text-sm">The AI could not extract any specific keywords.</p>`;
        }
    }
    
    function renderMatchAnalysis(data) {
        const panel = document.getElementById('ai-match-panel');
         panel.innerHTML = `
            <h4 class="font-semibold text-muted-foreground text-sm mb-2">Profile Match Analysis</h4>
            <div class="text-3xl font-bold text-primary">${data.match_percentage}%</div>
            <p class="text-sm text-card-foreground mt-2">${data.justification}</p>
           `;
    }
    
    // --- Start the App ---
    init();
});
</script>
</body>
</html>
